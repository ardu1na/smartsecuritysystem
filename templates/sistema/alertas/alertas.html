{% extends 'layout/base.html' %}

{% load static %}

{% block additional_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>    
    
    
{% endblock %}

{% block content %}

<div id="social" class="alert alert-social google-plus alert-dismissible fade show" style="display: none;"> 
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close"><span><i class="mdi mdi-btn-close"></i></span>
    </button>
    <div class="media">
        <div class="alert-social-icon">
            <span><i class="mdi mdi-google-plus"></i></span>
        </div>
        <div class="media-body">
            <h5 class="mt-1 mb-2 text-white"></h5>
            <p class="mb-0"></p>
        </div>
    </div>
</div>

<!-- MAIN alarms -->
    

    <div class="row">

        <div class="col-xl-3 col-xxl-3 col-lg-3 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span id="spancolor" class="me-3 {% if ultima.tipo == "Emergencia" %}
                                                bgl-success text-success
                                            {% elif ultima.tipo == "SOS" %}
                                                 bgl-info text-info
                                            {% elif ultima.tipo == "Fuego" %}
                                                 bgl-danger text-danger
                                            {% else %}
                                                 bgl-primary text-primary
                                            {% endif %} bgl-primary text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M160.9 59.01C149.3 52.6 134.7 56.76 128.3 68.39C117.6 87.6 112 109.4 112 131.4c0 19.03 4.031 37.44 11.98 54.62c4.047 8.777 12.73 13.93 21.8 13.93c3.375 0 6.797-.7187 10.05-2.219C167.9 192.2 173.1 177.1 167.5 165.9C162.5 155.1 160 143.5 160 131.4c0-13.93 3.547-27.69 10.25-39.81C176.7 80.04 172.5 65.42 160.9 59.01zM62.61 2.363C46.17-4.32 27.58 3.676 20.95 20.02C7.047 54.36 0 90.69 0 127.1C0 165.3 7.047 201.7 20.95 236C25.98 248.5 37.97 256 50.63 256C54.61 256 58.69 255.3 62.61 253.7C79 247 86.91 228.4 80.27 212C69.47 185.3 64 157.1 64 128c0-29.06 5.469-57.3 16.27-83.99C86.91 27.64 79 8.988 62.61 2.363zM555 20.02c-6.609-16.41-25.23-24.31-41.66-17.66c-16.39 6.625-24.3 25.28-17.66 41.65C506.5 70.7 512 98.95 512 128c0 29.06-5.469 57.31-16.27 83.1C489.1 228.4 497 247 513.4 253.7C517.3 255.3 521.4 256 525.4 256c12.66 0 24.64-7.562 29.67-20C568.1 201.7 576 165.3 576 127.1C576 90.69 568.1 54.36 555 20.02zM420.2 58.23c-12.03 5.562-17.28 19.81-11.72 31.84C413.5 100.9 416 112.5 416 124.6c0 13.94-3.547 27.69-10.25 39.81c-6.422 11.59-2.219 26.22 9.375 32.62c3.688 2.031 7.672 3 11.61 3c8.438 0 16.64-4.47 21.02-12.37C458.4 168.4 464 146.6 464 124.6c0-19.03-4.031-37.43-11.98-54.62C446.5 57.89 432.1 52.7 420.2 58.23zM301.8 65.45C260.5 56.78 224 88.13 224 128c0 23.63 12.95 44.04 32 55.12v296.9c0 17.67 14.33 32 32 32s32-14.33 32-32V183.1c23.25-13.54 37.42-40.96 30.03-71.18C344.4 88.91 325 70.31 301.8 65.45z"/></svg>
                        </span>
                        <div class="media-body">
                            {% if ultima %}
                            <a href="{% if ultima.miembro %}{% url 'dashboard:usuario' pk=ultima.miembro.id %}{%else%}#{%endif%}" class="mb-0 fs-3" id="miembro"> <strong> Última: {{ultima.miembro}}</strong> </a>

                            <h5 class="mb-0 mb-3" id="tipoyalarma"> {{ultima.tipo}} en {{ultima.miembro.vivienda.alarma_vecinal}}</h5>

                            <p class="my-1 fs-5" id="hora">El {{ultima.datetime|date:"d/m/Y" }} a las {{ ultima.datetime|time:"H:i" }} hs</p>
                            {% else %}
                            
                            <h5 class="mb-0 mb-3"></h5>

                            <p class="my-1 fs-5">sin alertas</p>
                            {% endif %}

                        </div>
                    </div>
                    
                </div>
            </div>
        </div>



        


        <div class="col-xl-3 col-xxl-3 col-lg-3 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-success text-success">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6H511.8L512.5 447.7C512.6 483.2 483.9 512 448.5 512H128.1C92.75 512 64.09 483.3 64.09 448V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5H575.8zM328 232V176C328 167.2 320.8 160 312 160H264C255.2 160 248 167.2 248 176V232H192C183.2 232 176 239.2 176 248V296C176 304.8 183.2 312 192 312H248V368C248 376.8 255.2 384 264 384H312C320.8 384 328 376.8 328 368V312H384C392.8 312 400 304.8 400 296V248C400 239.2 392.8 232 384 232H328z"/></svg>
                        </span>
                        <div class="media-body">
                            <h4 class="mb-0">Emergencia</h4>

                            <p class="mb-3">{{emerg|length}} {% if emer|length != 1 %} alertas {% else %} alerta {% endif %}</p> 
                            {% if emerg %}
                            <p class="my-1 fs-5"> Ultima el {{last_e.datetime|date:"l d" }} a las {{ last_e.datetime|time:"H:i" }} hs en {{last_e.miembro.vivienda.alarma_vecinal}}</p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-xxl-3 col-lg-3 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-info text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M384 480C384 491.7 387.1 502.6 392.6 512H392C369.9 512 352 494.1 352 472V384C352 366.3 337.7 352 320 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L490.7 166.3C447.2 181.7 416 223.2 416 272V296.6C396.9 307.6 384 328.3 384 352L384 480zM528 192C572.2 192 608 227.8 608 272V320C625.7 320 640 334.3 640 352V480C640 497.7 625.7 512 608 512H448C430.3 512 416 497.7 416 480V352C416 334.3 430.3 320 448 320V272C448 227.8 483.8 192 528 192zM528 240C510.3 240 496 254.3 496 272V320H560V272C560 254.3 545.7 240 528 240z"/></svg>
                        </span>
                        <div class="media-body">
                            <h4 class="mb-0">SOS</h4>

                            <p class="mb-3">{{sos|length}} {% if sos|length != 1 %} alertas {% else %} alerta {% endif %}  </p> 
                            {% if sos %}
                            <p class="my-1 fs-5"> Ultima el {{last_s.datetime|date:"l d" }} a las {{ last_s.datetime|time:"H:i" }} hs en {{last_s.miembro.vivienda.alarma_vecinal}}</p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>




        <div class="col-xl-3 col-xxl-3 col-lg-3 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-danger text-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 350.1L288 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L447.3 128.1C434.9 127.2 422.3 131.1 412.5 139.9C377.1 171.5 346.9 207.6 325.2 242.7C304.3 276.5 288 314.9 288 350.1H288zM509 221.5C516.9 211.6 525.8 200.8 535.5 191.1C541.1 186.9 549.9 186.9 555.5 192C580.2 214.7 601.1 244.7 615.8 273.2C630.4 301.2 640 329.9 640 350.1C640 437.9 568.7 512 480 512C390.3 512 320 437.8 320 350.1C320 323.7 332.7 291.5 352.4 259.5C372.4 227.2 400.5 193.4 433.8 163.7C439.4 158.7 447.1 158.8 453.5 163.8C473.3 181.6 491.8 200.7 509 221.5V221.5zM550 336.1C548 332.1 546 328.1 543 324.1L507 367C507 367 449 293 445 288C415 324.1 400 346 400 370C400 419 436 448 481 448C499 448 515 443 530 432.1C560 412 568 370 550 336.1z"/></svg>
                        </span>
                        <div class="media-body">
                            <h4 class="mb-0">Fuego</h4>

                            <p class="mb-3">{{fuego|length}} {% if fuego|length != 1 %} alertas {% else %} alerta {% endif %}  </p> 
                            
                            {% if fuego %}
                            <p class="my-1 fs-5"> Ultima el {{last_f.datetime|date:"l d" }} a las {{ last_f.datetime|time:"H:i" }} hs en {{last_f.miembro.vivienda.alarma_vecinal}}</p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Inicio</a></li>

                <li class="breadcrumb-item active"><a>Alertas de Alarma</a></li>

            </ol>
        </div>


        <div class="col-xl-12">            
            <div class="card students-list px-5">

                <div class="d-flex flex-row-reverse px-xs-1 px-4 mt-4 mb-4">
                            
                </div>  


                <!-- TABLE alertas de alarma -->
                <div class="card-body py-0">
                    
                            <div class="table-responsive ">
                                <table id="example4" style="min-width: 845px" class="pb-4">
                                    <thead>
                                        <tr>
                                            <th>FECHA</th>
                                            <th>ALERTA</th>
                                            <th>BARRIO</th>
                                            <th>USUARIO</th>

                                            <th>DIRECCION</th>
                                        </tr>
                                    </thead>
                                    <tbody >{% if alertas %}
                                        {% for alerta in alertas %}
                                        <tr>
                                                {% comment "" %} SI EL USUARIO EL BARRIO O LA CASA ESTÁN CANCELADOS MANDAR EN EL LINK UNA DATA PARA 
                                                DAR UNA ALERTA EN LA VISTA {% endcomment %}

                                            <td>{{ alerta.datetime|date:"d/m/Y" }}   {{ alerta.datetime|time:"H:i" }}</td>

                                            


                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge badge-xl light {% if alerta.tipo == "Emergencia" %}
                                                            badge-success
                                                        {% elif alerta.tipo == "SOS" %}
                                                            badge-info
                                                        {% elif alerta.tipo == "Fuego" %}
                                                            badge-danger                                                        
                                                        {% else %}
                                                            badge-primary
                                                        {% endif %}">                                                            
                                                       {{alerta.tipo}}
                                                    </span>                                                
                                                </div>                                                
                                            </td>                                     

                                            <td>  <a href="{% if alerta.miembro.vivienda.alarma_vecinal.id %}{% url 'dashboard:barrio' pk=alerta.miembro.vivienda.alarma_vecinal.id %}{%else%}#{%endif%}">
                                                <strong> {{alerta.miembro.vivienda.alarma_vecinal}}</strong></a>
                                            </td>
                                            


                                            <td>  
                                                <div class="d-flex align-items-center">
                                                    <a href="{%if alerta.miembro.id %}{% url 'dashboard:usuario' pk=alerta.miembro.id %}{%else%}#{%endif%}">{{alerta.miembro}}</a>
                                                </div>
                                            </td>
                                            
                                            <td>  <a href="{%if alerta.miembro.vivienda.id  %}{% url 'dashboard:vivienda' pk=alerta.miembro.vivienda.id %}{%else%}#{%endif%}">{{alerta.miembro.vivienda}} </a></td>

                                            
                                        </tr>
                                        {% endfor %}
                                        {% endif %}
                                        
                                    </tbody>
                                    
                                </table>
                            </div>

                </div>
                <div class="form-floating pt-4 my-3 d-flex flex-row-reverse">

                    <a href="{% url 'dashboard:index' %}" class="btn fs-4 mx-2">
                        <i class="fa-solid fa-arrow-left me-2 fs-4"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
<!-- end MAIN alertas -->

{% endblock %}


{% block additional_js %}



<script>

    // Catch any initialization errors that occur when loading the external script
    $.fn.dataTable.ext.errMode = 'throw';
    
    // Modify the options of the external DataTables instance
    $(document).ready(function() {
        var table = $('#example4').DataTable();
    
        table.order([0, 'desc']).draw();
    });
    </script>




<!-- get real time last alert -->
<script>
    var previousData = null;

function updateUltima() {
  $.ajax({
    url: 'latest/',
    success: function(data) {
      if (previousData !== null && JSON.stringify(data) !== JSON.stringify(previousData)) {
        // New data has been received, display an alert
        var tipo = data.tipo;

            var icon = 'fas fa-star star-orange';
            var color = 'alert-info';

            if (tipo === 'Emergencia') {
                color = 'facebook';
                icon = 'fa-hospital';


            } else if (tipo === 'SOS') {
                color = 'google-plus';
                icon = 'fa-lock';


            } else if (tipo === 'Fuego') {
                color = 'alert-warning solid';
                icon = 'fa-fire';
            }

            $("#social").after('<div class="alert alert-social ' + color + ' alert-dismissible fade show">' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close">' +
                '<span><i class="mdi mdi-btn-close"></i></span></button>' +
                '<div class="media">' +
                '<div class="alert-social-icon"><span><i class="fa ' + icon +'"></i></span></div>' +
                '<div class="media-body">' +
                '<h5 class="mt-1 mb-2 text-white">' + data.tipo + ' </h5>' +
                '<p class="mb-0"> En ' + data.alarma_vecinal + ' ' + data.datetime + '</p>' +
                '</div></div></div>');

            // Send a WhatsApp message
       
      }

      previousData = data;

      // Update the relevant HTML elements with the latest data
      $('#tipoyalarma').text(data.tipo + ' en ' + data.alarma_vecinal);
      $('#hora').text('El ' + data.datetime + ' hs');
      $('#miembro').text('Última: ' + data.miembro);
      $('#miembro').attr('href', data.userurl);
      
      var tipo = data.tipo;
            var span = $('#spancolor');

            if (tipo === 'Emergencia') {
                if (span.hasClass('bgl-info text-info') || span.hasClass('bgl-danger text-danger')) {
                    span.removeClass('text-info text-danger bgl-info bgl-danger');
                }
                span.addClass('text-success bgl-success');
            } else if (tipo === 'SOS') {
                if (span.hasClass('bgl-success text-success')  || span.hasClass('bgl-danger text-danger')) {
                    span.removeClass('text-success text-danger bgl-successbgl-danger');
                }
                span.addClass('text-info bgl-info');
            } else if (tipo === 'Fuego') {
                if (span.hasClass('bgl-success text-success') || span.hasClass('bgl-info text-info') ) {
                    span.removeClass('text-success text-info bgl-success bgl-info');
                }
                span.addClass('text-danger bgl-danger');
            }

    },
    complete: function() {
      setTimeout(updateUltima, 10000);
    }
  });
}

$(document).ready(function() {
  $.ajax({
    url: 'latest/',
    success: function(data) {
      previousData = data;
      // . ..
    },
    complete: function() {
      setTimeout(updateUltima, 10000);
    }
  });
});

    
    </script>
    


{% endblock %}