{% extends 'layout/base.html' %}

{% load static %}

{% block additional_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}



<!-- MAIN CLIENTS -->
    

    <div class="row">


        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-warning text-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 48C288 21.49 309.5 0 336 0H432C458.5 0 480 21.49 480 48V192H520V120C520 106.7 530.7 96 544 96C557.3 96 568 106.7 568 120V192H592C618.5 192 640 213.5 640 240V464C640 490.5 618.5 512 592 512H336C309.5 512 288 490.5 288 464V48zM352 112C352 120.8 359.2 128 368 128H400C408.8 128 416 120.8 416 112V80C416 71.16 408.8 64 400 64H368C359.2 64 352 71.16 352 80V112zM368 160C359.2 160 352 167.2 352 176V208C352 216.8 359.2 224 368 224H400C408.8 224 416 216.8 416 208V176C416 167.2 408.8 160 400 160H368zM352 304C352 312.8 359.2 320 368 320H400C408.8 320 416 312.8 416 304V272C416 263.2 408.8 256 400 256H368C359.2 256 352 263.2 352 272V304zM528 256C519.2 256 512 263.2 512 272V304C512 312.8 519.2 320 528 320H560C568.8 320 576 312.8 576 304V272C576 263.2 568.8 256 560 256H528zM512 400C512 408.8 519.2 416 528 416H560C568.8 416 576 408.8 576 400V368C576 359.2 568.8 352 560 352H528C519.2 352 512 359.2 512 368V400zM224 160C224 166 223 171 222 176C242 190 256 214 256 240C256 285 220 320 176 320H160V480C160 498 145 512 128 512C110 512 96 498 96 480V320H80C35 320 0 285 0 240C0 214 13 190 33 176C32 171 32 166 32 160C32 107 74 64 128 64C181 64 224 107 224 160z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Viviendas</p>
                            <h4 class="mb-0"> {{barrio.get_n_viviendas}}</h4>
                            <h5 class="mb-0"> {{barrio.get_alarmas_this_m|length}} Alertas este mes </h5>

                        </div>
                    </div>
                    
                </div>
            </div>
        </div>


        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 {% if ultima.tipo == "Emergencia" %}
                        bgl-success text-success
                            {% elif ultima.tipo == "SOS" %}
                                bgl-info text-info
                            {% elif ultima.tipo == "Fuego" %}
                                bgl-danger text-danger
                            {% else %}
                                bgl-primary text-primary
                            {% endif %} bgl-primary text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M160.9 59.01C149.3 52.6 134.7 56.76 128.3 68.39C117.6 87.6 112 109.4 112 131.4c0 19.03 4.031 37.44 11.98 54.62c4.047 8.777 12.73 13.93 21.8 13.93c3.375 0 6.797-.7187 10.05-2.219C167.9 192.2 173.1 177.1 167.5 165.9C162.5 155.1 160 143.5 160 131.4c0-13.93 3.547-27.69 10.25-39.81C176.7 80.04 172.5 65.42 160.9 59.01zM62.61 2.363C46.17-4.32 27.58 3.676 20.95 20.02C7.047 54.36 0 90.69 0 127.1C0 165.3 7.047 201.7 20.95 236C25.98 248.5 37.97 256 50.63 256C54.61 256 58.69 255.3 62.61 253.7C79 247 86.91 228.4 80.27 212C69.47 185.3 64 157.1 64 128c0-29.06 5.469-57.3 16.27-83.99C86.91 27.64 79 8.988 62.61 2.363zM555 20.02c-6.609-16.41-25.23-24.31-41.66-17.66c-16.39 6.625-24.3 25.28-17.66 41.65C506.5 70.7 512 98.95 512 128c0 29.06-5.469 57.31-16.27 83.1C489.1 228.4 497 247 513.4 253.7C517.3 255.3 521.4 256 525.4 256c12.66 0 24.64-7.562 29.67-20C568.1 201.7 576 165.3 576 127.1C576 90.69 568.1 54.36 555 20.02zM420.2 58.23c-12.03 5.562-17.28 19.81-11.72 31.84C413.5 100.9 416 112.5 416 124.6c0 13.94-3.547 27.69-10.25 39.81c-6.422 11.59-2.219 26.22 9.375 32.62c3.688 2.031 7.672 3 11.61 3c8.438 0 16.64-4.47 21.02-12.37C458.4 168.4 464 146.6 464 124.6c0-19.03-4.031-37.43-11.98-54.62C446.5 57.89 432.1 52.7 420.2 58.23zM301.8 65.45C260.5 56.78 224 88.13 224 128c0 23.63 12.95 44.04 32 55.12v296.9c0 17.67 14.33 32 32 32s32-14.33 32-32V183.1c23.25-13.54 37.42-40.96 30.03-71.18C344.4 88.91 325 70.31 301.8 65.45z"/></svg>
                        </span>
                        <div class="media-body">{% if ultima %}
                            <p class="mb-1">Última alerta: {{ultima.datetime}}</p>
                            <h4 class="mb-0"> {{ultima.tipo}} en
                                 <a href="{% url 'dashboard:vivienda' pk=ultima.miembro.vivienda.pk %}">{{ultima.miembro.vivienda.get_direccion}} </a></h4>
                            <h5 class="mb-0"> ,<a href="{% url 'dashboard:usuario' pk=ultima.miembro.pk %}"> {{ultima.miembro}}  </a></h5>
                                                {% else %}
                                                <p class="mb-1">Sin alertas</p>
                                                <h4 class="mb-0"> {{ultima.tipo}}  {{ultima.miembro.vivienda.get_direccion}} </h4>
                                                <h5 class="mb-0">   {{ultima.miembro.get_nombre_completo}} </h5>
                                                {% endif %}

                        </div>
                    </div>
                    
                </div>
            </div>
        </div>


        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <a href="{% url 'dashboard:usuariosbarrio' pk=barrio.pk %}" name="pk">

                <div class="widget-stat card">
                    <div class="card-body  p-4">
                        <div class="media ai-icon">
                            <span class="me-3 bgl-secondary text-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M511.8 287.6L512.5 447.7C512.6 483.2 483.9 512 448.5 512H128.1C92.75 512 64.09 483.3 64.09 448V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L416 100.7V64C416 46.33 430.3 32 448 32H480C497.7 32 512 46.33 512 64V185L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6L511.8 287.6zM288 288C323.3 288 352 259.3 352 224C352 188.7 323.3 160 288 160C252.7 160 224 188.7 224 224C224 259.3 252.7 288 288 288zM192 416H384C392.8 416 400 408.8 400 400C400 355.8 364.2 320 320 320H256C211.8 320 176 355.8 176 400C176 408.8 183.2 416 192 416z"/></svg>
                            </span>
                            <div class="media-body">
                                <p class="mb-1">Usuarios</p>
                                <h4 class="mb-0"> {{barrio.get_n_usuarios}}  </h4>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </a>
        </div>

        


        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-success text-success">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6H511.8L512.5 447.7C512.6 483.2 483.9 512 448.5 512H128.1C92.75 512 64.09 483.3 64.09 448V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5H575.8zM328 232V176C328 167.2 320.8 160 312 160H264C255.2 160 248 167.2 248 176V232H192C183.2 232 176 239.2 176 248V296C176 304.8 183.2 312 192 312H248V368C248 376.8 255.2 384 264 384H312C320.8 384 328 376.8 328 368V312H384C392.8 312 400 304.8 400 296V248C400 239.2 392.8 232 384 232H328z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{e_this_m|length}} alertas este mes </p>
                            <h4 class="mb-0">Urgencia</h4>
                            {% if e_this_m %}

                            <p class="my-1 fs-5"> último: {{emergencia.miembro}} - {{emergencia.datetime}} </p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-info text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M384 480C384 491.7 387.1 502.6 392.6 512H392C369.9 512 352 494.1 352 472V384C352 366.3 337.7 352 320 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L490.7 166.3C447.2 181.7 416 223.2 416 272V296.6C396.9 307.6 384 328.3 384 352L384 480zM528 192C572.2 192 608 227.8 608 272V320C625.7 320 640 334.3 640 352V480C640 497.7 625.7 512 608 512H448C430.3 512 416 497.7 416 480V352C416 334.3 430.3 320 448 320V272C448 227.8 483.8 192 528 192zM528 240C510.3 240 496 254.3 496 272V320H560V272C560 254.3 545.7 240 528 240z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{s_this_m|length}} alertas este mes </p>
                            <h4 class="mb-0">SOS</h4>
                            {% if s_this_m %}

                            <p class="my-1 fs-5"> último: {{sos.miembro}} - {{sos.datetime}} </p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}                        </div>
                    </div>
                </div>
            </div>
        </div>




        <div class="col-xl-4 col-xxl-4 col-lg-4 col-sm-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-danger text-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 350.1L288 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L447.3 128.1C434.9 127.2 422.3 131.1 412.5 139.9C377.1 171.5 346.9 207.6 325.2 242.7C304.3 276.5 288 314.9 288 350.1H288zM509 221.5C516.9 211.6 525.8 200.8 535.5 191.1C541.1 186.9 549.9 186.9 555.5 192C580.2 214.7 601.1 244.7 615.8 273.2C630.4 301.2 640 329.9 640 350.1C640 437.9 568.7 512 480 512C390.3 512 320 437.8 320 350.1C320 323.7 332.7 291.5 352.4 259.5C372.4 227.2 400.5 193.4 433.8 163.7C439.4 158.7 447.1 158.8 453.5 163.8C473.3 181.6 491.8 200.7 509 221.5V221.5zM550 336.1C548 332.1 546 328.1 543 324.1L507 367C507 367 449 293 445 288C415 324.1 400 346 400 370C400 419 436 448 481 448C499 448 515 443 530 432.1C560 412 568 370 550 336.1z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{f_this_m|length}} alertas este mes </p>
                            <h4 class="mb-0">FUEGO</h4>
                            {% if f_this_m %}

                            <p class="my-1 fs-5"> último: {{fuego.miembro}} - {{fuego.datetime}} </p>
                            {% else %}
                            <p class="my-1 fs-5"> sin alertas </p>
                            {% endif %}   
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Inicio</a></li>

                <li class="breadcrumb-item"><a href="{% url 'dashboard:barrios' %}">Alarmas Vecinales</a></li>

                <li class="breadcrumb-item active"><a> Viviendas en {{barrio.nombre}} </a> </li>
            </ol>
        </div>
       




        <div class="col-xl-12">            
            <div class="card students-list">


                <div class="d-flex flex-row-reverse px-xs-1 px-4 py-3 ">
                    <button type="button" class="btn btn-dark py-4" data-bs-toggle="modal" data-bs-target="#exampleModal">
                        <i class="fa fa-plus me-2 fs-3 me-3"></i><i class="fa-solid fa-house fs-2"></i></button>

                </div>      
                
                

                <!-- TABLE VIVIENDAS -->
                <div class="card-body py-0">
                            <div class="table-responsive">
                                <table id="example4" style="min-width: 845px">
                                    <thead>
                                        <tr>
                                            <th>DIRECCION</th>
                                            <th>MUNICIPIO</th>
                                            <th>PROVINCIA</th>
                                            <th>N° MIEMBROS</th>
                                            <th>MIEMBROS</th>
                                            <th>FECHA ALTA</th>

                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>{% if viviendas %}
                                        {% for vivienda in viviendas %}
                                        <tr>

                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <a class="mb-0 fs-16 font-w500" href="{% url 'dashboard:vivienda' pk=vivienda.id %}">{{vivienda.get_direccion}}</a>
                                                </div>
                                            </td>
                                            <td>{{vivienda.municipio}}</td>
                                            <td>{{vivienda.provincia}}</td>
                                            <td>{{vivienda.get_miembros_number}}</td>
                                            <td>{{vivienda.get_miembros_string|truncatechars:25}}</td>

                                            <td>{{vivienda.created_at}}</td>


                                            <td>
                                                <div class="d-flex flex-row">

                                                     <!-- map BUTTON -->
                                                     <a href="{{vivienda.get_map}}" class="shadow-sm btn btn-info px-3 mx-1"><i class="fa-solid fa-location-dot fs-4"></i>
                                                     </a>  
                                                    
                                                        <!-- delete BUTTON -->
                                                            <button type="button" class="shadow-sm btn btn-danger px-3 mx-1" data-bs-toggle="modal" data-bs-target="#deletevivienda{{vivienda.id}}">
                                                            <i class="fa-solid fa-trash fs-4"></i>  
                                                            </button>                                                                                  
                                                        <!-- edit BUTTON -->

                                                            <a href="{% url 'dashboard:viviendaedit' pk=vivienda.id %}" class="px-3 shadow-sm btn btn-secondary mx-1">
                                                                <i class="fa-solid fa-pen-to-square fs-4 "></i>
                                                            </a>          
                                                            
                                                          
                                                </div>                                        
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% endif %}

                                    </tbody>
                                </table>

                              
                            </div>

                </div>
                <div class="form-floating pt-4 my-3 d-flex flex-row-reverse">

                    <a href="{% url 'dashboard:barrios'%}" class="btn fs-4 mx-2">
                        <i class="fa-solid fa-arrow-left me-2 fs-4"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
<!-- end MAIN viviendas -->


<!-- modals delete viviendas -->
    {% for vivienda in viviendas %}
        <div class="modal" id="deletevivienda{{vivienda.id}}">
            {% include 'dashboard/sistema/barrios/deletevivienda.html' %}
        </div>
    {% endfor %}


<!-- START modal add vivienda -->
    <div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Nueva Vivienda</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>           
                <form  method="post">
                    {% csrf_token %}
                        <div class="modal-body">
                            <div class="pt-1 pb-4">
                                <div class="formcontrol">                                         
                                    <div class="form-floating mb-3">
                                        <input type="hidden" name="alarma_vecinal" value="{{ barrio.id }}">
        
                                        <div class="form-group my-3">
                                            
                                            {{addform.calle}}
                                        </div>
                                        <div class="form-group my-3">
                                            {{addform.numero}}                                             {{addform.sin_numero}}

                                        </div>
                                        <div class="form-group my-3">
                                            {{addform.departamento}}
                                        </div>

                                        <div class="form-group my-3">
                                            {{addform.municipio}}
                                        </div>


                                        <div class="form-group my-3">
                                            {{addform.provincia}}
                                        </div>


                                        <div class="form-group my-3">
                                            {{addform.altitud}}
                                        </div>

                                        <div class="form-group my-3">
                                            {{addform.latitud}}
                                        </div>
        
                                        <div class="form-group my-3">
                                            
                                            {{addform.nota}}
                                        </div>
                                    </div>
                                </div>       
        
                                
                            </div>
                            <div class="form-floating my-3 text-center">
                                <button type="submit" class=" fs-3 shadow-sm btn btn-secondary" name="addnew"><i class="fa fa-plus me-2 fs-3 me-3"></i> Agregar </button>
                            </div>
                        </div>
                    </form>
            </div>
        </div>
    </div>
<!-- END modal add vivienda -->
{% endblock %}


{% block additional_js %}
    <!-- NEWMODAL -->
        <script>
            const deletevivienda = new bootstrap.Modal('#deletevivienda',   {keyboard: true}    )
        </script>

    <!-- charts -->
    <script src="{% static 'dashboard/vendor/apexcharts/apexcharts.min.js' %}"></script>
    <script src="{% static 'dashboard/vendor/chart.js/chart.min.js' %}"></script>
    <script src="{% static 'dashboard/vendor/echarts/echarts.min.js' %}"></script>

   

    
<script>

    var lastChecked = null;
  
    $(document).ready(function() {
      // Escuchar el evento 'click' en los checkboxes de la tabla
      $('#example4 tbody').on('click', 'input[type="checkbox"]', function(e) {
        if(!lastChecked) {
          lastChecked = this;
          return;
        }
  
        if(e.shiftKey) {
          var start = $('#example4 tbody input[type="checkbox"]').index(this);
          var end = $('#example4 tbody input[type="checkbox"]').index(lastChecked);
  
          $('#example4 tbody input[type="checkbox"]').slice(Math.min(start,end), Math.max(start,end)+ 1).prop('checked', lastChecked.checked);
  
        }
  
        lastChecked = this;
      });
    });
  </script>

{% endblock %}