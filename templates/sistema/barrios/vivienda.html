{% extends 'layout/base.html' %}

{% load static widget_tweaks %}

{% block additional_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}



<!-- MAIN USUARIOS -->

    <div class="row">

       <div class="col-xl-3 col-xxl-3 col-lg-3">
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 {% if ultima.tipo == "Emergencia" %}
                                        bgl-success text-success
                                    {% elif ultima.tipo == "SOS" %}
                                        bgl-info text-info
                                    {% elif ultima.tipo == "Fuego" %}
                                        bgl-danger text-danger
                                    {% else %}
                                        bgl-primary text-primary
                                    {% endif %} bgl-primary text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M160.9 59.01C149.3 52.6 134.7 56.76 128.3 68.39C117.6 87.6 112 109.4 112 131.4c0 19.03 4.031 37.44 11.98 54.62c4.047 8.777 12.73 13.93 21.8 13.93c3.375 0 6.797-.7187 10.05-2.219C167.9 192.2 173.1 177.1 167.5 165.9C162.5 155.1 160 143.5 160 131.4c0-13.93 3.547-27.69 10.25-39.81C176.7 80.04 172.5 65.42 160.9 59.01zM62.61 2.363C46.17-4.32 27.58 3.676 20.95 20.02C7.047 54.36 0 90.69 0 127.1C0 165.3 7.047 201.7 20.95 236C25.98 248.5 37.97 256 50.63 256C54.61 256 58.69 255.3 62.61 253.7C79 247 86.91 228.4 80.27 212C69.47 185.3 64 157.1 64 128c0-29.06 5.469-57.3 16.27-83.99C86.91 27.64 79 8.988 62.61 2.363zM555 20.02c-6.609-16.41-25.23-24.31-41.66-17.66c-16.39 6.625-24.3 25.28-17.66 41.65C506.5 70.7 512 98.95 512 128c0 29.06-5.469 57.31-16.27 83.1C489.1 228.4 497 247 513.4 253.7C517.3 255.3 521.4 256 525.4 256c12.66 0 24.64-7.562 29.67-20C568.1 201.7 576 165.3 576 127.1C576 90.69 568.1 54.36 555 20.02zM420.2 58.23c-12.03 5.562-17.28 19.81-11.72 31.84C413.5 100.9 416 112.5 416 124.6c0 13.94-3.547 27.69-10.25 39.81c-6.422 11.59-2.219 26.22 9.375 32.62c3.688 2.031 7.672 3 11.61 3c8.438 0 16.64-4.47 21.02-12.37C458.4 168.4 464 146.6 464 124.6c0-19.03-4.031-37.43-11.98-54.62C446.5 57.89 432.1 52.7 420.2 58.23zM301.8 65.45C260.5 56.78 224 88.13 224 128c0 23.63 12.95 44.04 32 55.12v296.9c0 17.67 14.33 32 32 32s32-14.33 32-32V183.1c23.25-13.54 37.42-40.96 30.03-71.18C344.4 88.91 325 70.31 301.8 65.45z"/></svg>
                    </span>
                        <div class="media-body">
                            <p class="mb-1">Última alerta {{ultima.datetime}}</p>
                            <h4 class="mb-0">  {{ultima.tipo}} </h4>
                            <h5 class="mb-0"> {{ultima.miembro}} </h5>

                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        


        <div class="col-xl-3 col-xxl-3 col-lg-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-success text-success">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6H511.8L512.5 447.7C512.6 483.2 483.9 512 448.5 512H128.1C92.75 512 64.09 483.3 64.09 448V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5H575.8zM328 232V176C328 167.2 320.8 160 312 160H264C255.2 160 248 167.2 248 176V232H192C183.2 232 176 239.2 176 248V296C176 304.8 183.2 312 192 312H248V368C248 376.8 255.2 384 264 384H312C320.8 384 328 376.8 328 368V312H384C392.8 312 400 304.8 400 296V248C400 239.2 392.8 232 384 232H328z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{e|length}}  {% if e|length != 1 %} alertas {% else %}alertas{% endif %}  </p>
                            <h4 class="mb-0">Urgencia</h4>
                            <p class="my-1 fs-5"> {% with e_last=e.last %} {{e_last.miembro}} {{ e_last.datetime}}{% endwith %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-xxl-3 col-lg-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-info text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M384 480C384 491.7 387.1 502.6 392.6 512H392C369.9 512 352 494.1 352 472V384C352 366.3 337.7 352 320 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L490.7 166.3C447.2 181.7 416 223.2 416 272V296.6C396.9 307.6 384 328.3 384 352L384 480zM528 192C572.2 192 608 227.8 608 272V320C625.7 320 640 334.3 640 352V480C640 497.7 625.7 512 608 512H448C430.3 512 416 497.7 416 480V352C416 334.3 430.3 320 448 320V272C448 227.8 483.8 192 528 192zM528 240C510.3 240 496 254.3 496 272V320H560V272C560 254.3 545.7 240 528 240z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{s|length}}  {% if s|length != 1 %} alertas {% else %}alertas{% endif %} </p>
                            <h4 class="mb-0">SOS</h4>
                            <p class="my-1 fs-5"> {% with s_last=s.last %} {{s_last.miembro}} {{ s_last.datetime}}{% endwith %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <div class="col-xl-3 col-xxl-3 col-lg-3">
            <div class="widget-stat card">
                <div class="card-body p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-danger text-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 350.1L288 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L447.3 128.1C434.9 127.2 422.3 131.1 412.5 139.9C377.1 171.5 346.9 207.6 325.2 242.7C304.3 276.5 288 314.9 288 350.1H288zM509 221.5C516.9 211.6 525.8 200.8 535.5 191.1C541.1 186.9 549.9 186.9 555.5 192C580.2 214.7 601.1 244.7 615.8 273.2C630.4 301.2 640 329.9 640 350.1C640 437.9 568.7 512 480 512C390.3 512 320 437.8 320 350.1C320 323.7 332.7 291.5 352.4 259.5C372.4 227.2 400.5 193.4 433.8 163.7C439.4 158.7 447.1 158.8 453.5 163.8C473.3 181.6 491.8 200.7 509 221.5V221.5zM550 336.1C548 332.1 546 328.1 543 324.1L507 367C507 367 449 293 445 288C415 324.1 400 346 400 370C400 419 436 448 481 448C499 448 515 443 530 432.1C560 412 568 370 550 336.1z"/></svg>
                        </span>
                        <div class="media-body">
                            <p class="mb-1">{{f|length}}   {% if f|length != 1 %} alertas {% else %}alertas{% endif %}  </p>
                            <h4 class="mb-0"> Fuego</h4>
                            <p class="my-1 fs-5">{% with f_last=f.last %} {{f_last.miembro}} {{ f_last.datetime}}{% endwith %}</p>

                        </div>
                    </div>
                </div>
            </div>
        </div>


    
        <div class="row page-titles">
            <ol class="breadcrumb">
        
                <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Inicio</a></li>
        
                        <li class="breadcrumb-item"><a href="{% url 'dashboard:barrios' %}">Alarmas Vecinales</a></li>
        
                <li class="breadcrumb-item"><a href="{% url 'dashboard:barrio' pk=vivienda.alarma_vecinal.id %}">{{vivienda.alarma_vecinal}}</a></li>
        
                <li class="breadcrumb-item active"><a>{{vivienda.get_direccion}}</a></li>
            </ol>
        </div>

        
        
        <div class="col-xl-12">            
            <div class="card students-list">

                <div class="d-flex flex-row-reverse px-xs-1 px-4 mt-4 mb-4">
                    <button type="button" class="btn btn-dark py-4 px-4" data-bs-toggle="modal" data-bs-target="#exampleModal">
                        <i class="fa fa-plus fs-3 me-3"></i><i class="fa-solid fa-user fs-2"></i></button>

                            
                </div>       
                
                 


                <!-- TABLE USUARIOS -->
                <div class="card-body py-0">
                            <div class="table-responsive">
                                <table id="example4" style="min-width: 845px">
                                    <thead>
                                        <tr>
                                            <th>NOMBRE</th>
                                            <th>APELLIDO</th>
                                            <th>EDAD</th>
                                            <th>H/M</th>

                                            <th>ALARMAS ESTE MES</th>
                                            <th>ALARMAS ESTE AÑO</th>
                                            <th>ALTA</th>

                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for usuario in usuarios %}
                                        <tr>

                                            <td>
                                                <div class="d-flex align-items-center">
                                                    
                                                    <a class="mb-0 fs-16 font-w500" href="{% url 'dashboard:usuario' pk=usuario.pk %}"></a>
                                                    <!-- ver code BUTTON -->
                                                    <button type="button" class="btn mb-0 fs-16 font-w500" data-bs-toggle="modal" data-bs-target="#detail{{usuario.id}}">
                                                       {{usuario}} </button> 


                                                                                                                
                                                        <!-- START modal ver usuario -->
                                                        <div class="modal fade " id="detail{{usuario.id}}" tabindex="-1" aria-labelledby="detail{{usuario.id}}Label" aria-hidden="true">
                                                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                                                <div class="modal-content px-3">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>           
                                                                    <div class="modal-body text-center my-2">


                                                                        <h3 class="mb-3"> {{usuario.nombre}} {{usuario.apellido}} {% if usuario.fecha_de_nacimiento %} ({{usuario.get_edad}} años) {% endif %}</h3>

                                                                       
                                                                        <div class="col-6 m-auto">
                                                                            {% if usuario.avatar %} <img class="img-fluid w-100 h-100" src="{{ usuario.avatar.url }}"  alt="">{% endif %}
                                                                        </div>
                                                                        <br>
                                                                        <br>
              

                                                                                            <a href="{% url 'dashboard:usuarioalertas' pk=usuario.id %}"> Ver Alertas de {{usuario.nombre}}
                                                                                            <h4 >{{usuario.alertas.all|length}} {% if usuario.alearts.all|length != 1 %} alertas {% else %} alerta {% endif %}</h4></a>
                                                                                            <hr>


                                                                                           

                                                                                            <div class="text-start my-5">

                                                                                                <p class="mb-1"><a class="pe-4"><strong>Dirección:</strong></a> {{usuario.vivienda.get_direccion}} - {{usuario.vivienda.alarma_vecinal}}</p>
                                                                                                <p class="mb-1"><a class="pe-4"><strong>Teléfono:</strong></a> {{usuario.telefono}}</p>
                                                                                            </div>

                                                                                            {% if usuario.nota %}
                                                                                                <hr>
                                                                                                <div class="bio text-start my-4">
                                                                                                    <h4 class="mb-3">Nota de información médica</h4>
                                                                                                    <div class="bio-content">
                                                                                                        <p>{{usuario.nota}}</p>
                                                                                                    </div>
                                                                                                </div>
                                                                                            {% endif %}                                                                                          

                                                                                            <hr>
                                                                                            <div class="accordion accordion-with-icon" id="accordion-six">

                                                                                            <div class="accordion-item">
                                                                                                <div class="accordion-header  rounded-lg" id="accord-6One" data-bs-toggle="collapse" data-bs-target="#collapse6One" aria-controls="collapse6One"   aria-expanded="true"  role="button">
                                                                                                  <span class="accordion-header-text">Links para los widgets de Google Home </span>
                                                                                                  <i class="bi bi-phone-vibrate fs-3 mx-4"></i>
                                                                                                </div>
                                                                                                <div id="collapse6One" class="collapse accordion__body " aria-labelledby="accord-6One" data-bs-parent="#accordion-six">
                                                                                                  <div class="accordion-body-text">
                                                                                                        <h5> Fuego </h5>
                                                                                                        <p class="mb-1 form-control">  http://200.58.105.20/f/{{usuario.id}}</p>
                                                                                                        <h5> SOS </h5>
                        
                                                                                                        <p class="mb-1 form-control">  http://200.58.105.20/s/{{usuario.id}}</p>
                                                                                                        <h5> Emergencia </h5>
                        
                                                                                                        <p class="mb-1 form-control"> http://200.58.105.20/e/{{usuario.id}}</p>
                        
                                                                                                  </div>
                                                                                                </div>
                                                                                                </div>
                                                                                            </div>
                                                                    </div> 
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- END modal ver usuario -->
                                                </div>
                                            </td>
                                            <td>{{usuario.apellido}}</td>
                                            <td>{{usuario.get_edad}}</td>
                                            <td>{{usuario.genero}}</td>

                                            <td>{{usuario.alarmas_this_m|length}}</td>
                                            <td>{{usuario.alarmas_this_y|length}}</td>
                                            <td>{{usuario.created_at}}</td>

                                            <td>
                                                <div class="d-flex flex-row">
                                                    
                                                        <!-- delete BUTTON -->
                                                            <button type="button" class="shadow-sm btn btn-danger px-3 mx-1" data-bs-toggle="modal" data-bs-target="#deleteusuario{{usuario.id}}">
                                                            <i class="fa-solid fa-trash fs-4"></i>
                                                            </button>                                                                                  
                                                        <!-- edit BUTTON -->
                                                            <a href="{% url 'dashboard:usuario' pk=usuario.pk %}" class="px-3 shadow-sm btn btn-secondary mx-1">
                                                                <i class="fa-solid fa-pen-to-square fs-4 "></i>
                                                            </a>        
                                                            
                                                        <!-- map BUTTON -->
                                                        <a href="{{usuario.vivienda.get_map}}" class="shadow-sm btn btn-info px-3 mx-1"><i class="fa-solid fa-location-dot fs-4"></i>
                                                        </a>  


                                                                                                                    
                                                           
                                                </div>                                        
                                            </td>
                                        </tr>
                                        {% endfor %}

                                    </tbody>
                                </table>

                              
                            </div>

                </div>
                <div class="form-floating pt-4 my-3 d-flex flex-row-reverse">

                    <a href="{% url 'dashboard:barrio' pk=vivienda.alarma_vecinal.pk %}" class="btn fs-4 mx-2">
                        <i class="fa-solid fa-arrow-left me-2 fs-4"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
<!-- end MAIN usuarios -->


<!-- modals delete usuarios -->
    {% for usuario in usuarios %}
        <div class="modal" id="deleteusuario{{usuario.id}}">
            {% include 'dashboard/sistema/barrios/deleteusuario.html' %}
        </div>
    {% endfor %}


<!-- START modal add usuario -->
    <div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Nuevo Usuario</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>           
                <form  method="post" enctype="multipart/form-data" novalidate autocomplete="off">
                    {% csrf_token %}
                        <div class="modal-body">
                            <div class="pt-1 pb-4">
                                <div class="formcontrol">                                         
                                    <div class="form-floating mb-3">
                                        <input type="hidden" name="vivienda" value="{{ vivienda.id }}">
        
                                        <div class="form-group my-3">
                                            
                                            {{addform.nombre}}
                                        </div>
                                        <div class="form-group my-3">
                                            {{addform.apellido}}
                                        </div>
                                        <div class="form-group my-3">
                                            {{addform.telefono}}
                                        </div>

                                        <div class="form-group my-3">
                                            {{addform.email}}
                                            <div class="text-danger w-100 d-block mt-1">
                                                {{ addform.email.errors }}
                                                </div>
                                        </div>
                                        <div class="form-group my-3">
                                            {{addform.genero}}
                                        </div>


                                        <div class="form-group my-3">
                                            {{addform.fecha_de_nacimiento}}
                                        </div>

                                        <div class="form-group my-3">
                                            {{addform.nota}}
                                        </div>

                                        <div class="mb-3 col-md-6">
                                            <div class="avatar-upload">
                                               <div class="avatar-edit">
                                                  {{ addform.avatar|attr:"type:file" }}
                                                  <label for="id_avatar"><i class="fas fa-pencil-alt"></i></label>
                                               </div>
                                               <div class="avatar-preview">
                                                {% if addform.instance.avatar %}
                                                <div id="imagePreview" style="background-image: url('{{ addform.instance.avatar.url }}');">
                                              {% else %}
                                                <div id="imagePreview">
                                              {% endif %}
                                              
                                               </div>
                                         </div>
                                         <div class="text-danger w-100 d-block mt-1">
                                            {{ editform.avatar.errors }}     
                                        </div>

                                    </div>
                                </div>       
        
                                
                            </div>
                            <div class="form-floating my-3 text-center">
                                <button type="submit" class=" fs-3 shadow-sm btn btn-secondary" name="addnew"><i class="fa fa-plus me-2 fs-3 me-3"></i> Agregar </button>
                            </div>
                        </div>
                    </form>


            </div>
        </div>
    </div>
<!-- END modal add usuario -->
{% endblock %}


{% block additional_js %}




<script>
    function readURL(input) {
 
       if (input.files && input.files[0]) {
             var reader = new FileReader();
             reader.onload = function(e) {
                $('#imagePreview').css('background-image', 'url('+e.target.result +')');
                $('#imagePreview').hide();
                $('#imagePreview').fadeIn(650);
             }
             reader.readAsDataURL(input.files[0]);
       }
    }
    $("#id_avatar").change(function() {
       readURL(this);
    });
 </script> 
 
    <!-- NEWMODAL -->
        <script>
            const deleteusuario = new bootstrap.Modal('#deleteusuario',   {keyboard: true}    )
            const detail = new bootstrap.Modal('#detail',   {keyboard: true}    )


        </script>

      

{% endblock %}